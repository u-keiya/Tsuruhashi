# 2025-08-17 16:08 - Multi‑Bot 実装セッション (US-002)

## Summary
このセッションでは GitHub Issue #9 (US-002) に対応し、Control API の /bots/summon に複数同時生成(count)を追加して BotCore をマルチインスタンス対応にしました。実装は並列生成（Promise.all）により 1〜10 体の生成をサポートし、ユニークなユーザー名付与で接続競合を回避しています。単体テストを追加・修正し、機能の動作をローカルで検証したうえで Pull Request を作成しました（PR #19)。

### User Requirement
- US-002: 複数 Bot 同時運用（最大 10 体、TPS 低下しないこと）
- 該当 Issue: https://github.com/u-keiya/Tsuruhashi/issues/9

### Key Decisions (変更点・理由・参照)
- Control API の summon に `count` パラメータを追加し、配列で BotSummary を返す仕様にした（理由: API で複数生成を明示するため）。参照: Issue #9, PR #19 (https://github.com/u-keiya/Tsuruhashi/pull/19)
- Bot の接続時にユーザー名へタイムスタンプ付与により重複を避ける実装とした（理由: bedrock-protocol は username が重複すると接続衝突の恐れがあるため）。
- Bot の生成は並列 (Promise.all) にした（理由: 起動コストを短縮し同時接続を高速化するため）。
- MiningEngine 等既存のコンポーネントは Bot ID 毎に分離された設計のため、Bot インスタンス分離は既存設計で担保できる。

### Files changed (主要)
- [`src/types/bot.types.ts`](src/types/bot.types.ts:27)
- [`src/services/bot.service.ts`](src/services/bot.service.ts:25)
- [`src/controllers/bot.controller.ts`](src/controllers/bot.controller.ts:20)
- [`src/models/bot.model.ts`](src/models/bot.model.ts:35)
- [`tests/unit/bot.controller.test.ts`](tests/unit/bot.controller.test.ts:1)
- [`tests/unit/bot.service.test.ts`](tests/unit/bot.service.test.ts:1)

(各リンクはファイル先頭を指します)

### Traceability
- Issue: https://github.com/u-keiya/Tsuruhashi/issues/9
- Pull Request: https://github.com/u-keiya/Tsuruhashi/pull/19
- Commit (local): 8afd722 (ブランチ: `feat/9-multiple-bot-instances`)
- Spike doc (参考): [`docs/03_design/spike/bedrock-protocol.md`](docs/03_design/spike/bedrock-protocol.md:1)
- C4 container 図: [`docs/03_design/diagrams/c4/container.puml`](docs/03_design/diagrams/c4/container.puml:1)
- USDM: `US-002`（Issue #9 ヘッダ参照）

### Action Items (実行可能、担当ロール明記)
- [x] 実装: summon に `count` を追加し並列 Bot 生成を実装 (Dev)
- [x] テスト: sinon + chai を使った単体テストを追加/更新 (TE / Dev)
- [x] PR 作成: `feat/9-multiple-bot-instances` → `main` (Dev) — PR #19 作成済
- [ ] ドキュメント更新: API ドキュメント（OpenAPI / docs/03_design/api/openapi.yaml など）を `count` 仕様で更新して `label:docs` を付与して Issue を作成する (RA) — 下記に Issue 提案を含む
- [ ] ベンチ: Spike に従い Bot=10 で TPS≥18 を確認する負荷検証を実施 (SA / Dev) — 実環境での検証が必要

### Doc Gap Check
今回の実装は API の挙動を変更するため、ドキュメント（API OpenAPI spec / README / Design doc）を更新する必要があります。以下は作成を提案する `label:docs` Issue の定義（コピーして `github create_issue` で作成してください）。

---issue
{
  "title": "docs: update API docs for summon(count) parameter (US-002)",
  "body": "Control API `/bots/summon` に `count` パラメータを追加しました。API ドキュメント（OpenAPI spec、README のエンドポイント仕様、API 例）を以下の変更に合わせて更新してください:\n\n- リクエストボディに `count` (integer, optional, 1-10)\n- レスポンス: 既存の単一 BotSummary → BotSummary[] を返却する例を追加\n\n参照: Issue #9, PR #19\n\n影響ファイル候補:\n- [`docs/03_design/api/openapi.yaml`](docs/03_design/api/openapi.yaml:1)\n- README の API セクション\n\nラベル: [\"docs\"]\n",
  "labels": ["docs"]
}
---end

（上記 JSON をそのまま Issue 作成ツールに流して下さい）

### Open Questions
- スパイクベンチ (実サーバーでの負荷検証) を誰がいつ実施するかを確定してください（担当: SA / Dev 推奨）。
- API バージョンポリシー: `summon` のレスポンス型変更は互換性に影響するため、バージョン表記や移行案が必要かをプロダクトオーナーに確認してください（担当: PO / RA）。

### Notes / Observations
- Unit tests (BotController / BotService) はローカル CI で成功しています。全体テストスイート実行時に既存の一部テストで副作用（DB エラーなど）のログが出力されましたが、今回の変更が直接原因ではありません（詳細は実行ログを参照のこと）。
- 実運用での性能検証（Spike）は本実装の最終受け入れ条件です。ローカル単体テストは機能検証のみを目的とします。

----
作成者: DS (Documentation Synthesizer)  
生成元セッション: 開発者と自動化エージェントの対話（Issue #9 実装作業）  
PR: https://github.com/u-keiya/Tsuruhashi/pull/19